<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Spotify ‚Äî Pemutar Offline</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <style>
    body{ margin:0; font-family: Arial, sans-serif; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; height:100vh; }
    .player{ width:360px; background:#111827; border-radius:14px; padding:18px; }
    .cover{ height:160px; border-radius:10px; background:#374151; display:flex; align-items:center; justify-content:center; font-size:22px; margin-bottom:12px; }
    .title{ font-size:16px; font-weight:bold; }
    .artist{ font-size:12px; color:#9ca3af }
    .controls{ display:flex; gap:12px; justify-content:center; margin:12px 0; }
    button{ background:#1db954; border:0; color:#fff; cursor:pointer; padding:8px 12px; border-radius:6px; }
    .progress{ width:100%; }
    .playlist{ max-height:140px; overflow:auto; margin-top:12px; }
    .track{ display:flex; justify-content:space-between; align-items:center; padding:6px; border-radius:6px; cursor:pointer; }
    .track:hover{ background:#1db95422; }
    .track.active{ background:#1db95444; }
    .deleteBtn{ background:red; border:none; color:white; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:12px; }
  </style>
</head>
<body>
  <div class="player">
    <div class="cover" id="cover">üéµ</div>
    <div class="title" id="title">Tidak Ada Lagu</div>
    <div class="artist" id="artist">‚Äî</div>

    <input type="range" id="progress" class="progress" value="0" min="0" step="0.1" />

    <div class="controls">
      <button id="prev">‚èÆÔ∏è</button>
      <button id="play">‚ñ∂Ô∏è</button>
      <button id="next">‚è≠Ô∏è</button>
    </div>

    <input type="file" id="filePicker" accept="audio/*" multiple />

    <div class="playlist" id="playlist"></div>
  </div>

  <audio id="audio" preload="auto"></audio>

  <script>
    const DB_NAME = "miniSpotifyDB";
    const DB_STORE = "tracks";

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
          e.target.result.createObjectStore(DB_STORE, { keyPath: "id", autoIncrement: true });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function saveTrack(track) {
      const db = await openDB();
      const tx = db.transaction(DB_STORE, "readwrite");
      tx.objectStore(DB_STORE).add(track);
      return tx.complete;
    }

    async function getTracks() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const req = db.transaction(DB_STORE, "readonly").objectStore(DB_STORE).getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function deleteTrackFromDB(id) {
      const db = await openDB();
      const tx = db.transaction(DB_STORE, "readwrite");
      tx.objectStore(DB_STORE).delete(id);
      return tx.complete;
    }

    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("play");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const progress = document.getElementById("progress");
    const titleEl = document.getElementById("title");
    const artistEl = document.getElementById("artist");
    const playlistEl = document.getElementById("playlist");
    const filePicker = document.getElementById("filePicker");

    let playlist = [];
    let currentIndex = 0;
    let isPlaying = false;

    function renderPlaylist(){
      playlistEl.innerHTML = "";
      playlist.forEach((t,i)=>{
        const div = document.createElement("div");
        div.className = "track";
        if(i === currentIndex) div.classList.add("active");

        const span = document.createElement("span");
        span.textContent = t.title;
        span.onclick = ()=>{ loadTrack(i); playAudio(); };

        const delBtn = document.createElement("button");
        delBtn.className = "deleteBtn";
        delBtn.textContent = "‚ùå";
        delBtn.onclick = (e)=>{ 
          e.stopPropagation(); 
          deleteTrack(i, t.id); 
        };

        div.appendChild(span);
        div.appendChild(delBtn);
        playlistEl.appendChild(div);
      });
    }

    function loadTrack(index){
      currentIndex = index;
      const track = playlist[currentIndex];
      audio.src = track.src;
      titleEl.textContent = track.title;
      artistEl.textContent = track.artist;
      renderPlaylist();
    }

    function playAudio(){
      audio.play();
      isPlaying = true;
      playBtn.textContent = "‚è∏Ô∏è";
    }
    function pauseAudio(){
      audio.pause();
      isPlaying = false;
      playBtn.textContent = "‚ñ∂Ô∏è";
    }

    playBtn.onclick = ()=>{
      if(!audio.src && playlist.length > 0) loadTrack(0);
      if(isPlaying) pauseAudio(); else playAudio();
    };
    prevBtn.onclick = ()=>{ if(currentIndex>0){ loadTrack(currentIndex-1); playAudio(); } };
    nextBtn.onclick = ()=>{ if(currentIndex<playlist.length-1){ loadTrack(currentIndex+1); playAudio(); } };

    progress.addEventListener("input", e=>{ audio.currentTime = e.target.value; });
    audio.addEventListener("timeupdate", ()=>{
      progress.max = audio.duration || 0;
      progress.value = audio.currentTime || 0;
    });
    audio.addEventListener("ended", ()=>{ if(currentIndex<playlist.length-1){ loadTrack(currentIndex+1); playAudio(); } });

    // pilih file dari penyimpanan
    filePicker.addEventListener("change", async (event)=>{
      const files = event.target.files;
      for(let file of files){
        const url = URL.createObjectURL(file);
        const track = { title: file.name, artist:"Local File", src: url };
        await saveTrack(track); // simpan ke IndexedDB
      }
      playlist = await getTracks();
      if(playlist.length > 0){ loadTrack(0); }
      renderPlaylist();
    });

    // fungsi hapus track
    async function deleteTrack(index, id){
      await deleteTrackFromDB(id);
      playlist.splice(index,1);

      if(currentIndex >= playlist.length) currentIndex = playlist.length-1;
      if(currentIndex < 0) currentIndex = 0;

      if(playlist.length > 0){
        loadTrack(currentIndex);
      } else {
        audio.src = "";
        titleEl.textContent = "Tidak Ada Lagu";
        artistEl.textContent = "‚Äî";
        playBtn.textContent = "‚ñ∂Ô∏è";
      }
      renderPlaylist();
    }

    // Load playlist dari IndexedDB saat pertama kali
    window.addEventListener("load", async ()=>{
      playlist = await getTracks();
      if(playlist.length > 0){
        loadTrack(0);
      }
      renderPlaylist();
    });
  </script>
</body>
</html>